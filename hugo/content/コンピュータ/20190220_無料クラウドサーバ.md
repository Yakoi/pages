<!-- @import "[TOC]" {cmd="toc" depthFrom=2 depthTo=3 orderedList=true} -->

<!-- code_chunk_output -->

1. [20190224 HTTPS](#20190224-https)
2. [20190224 ドメインヒモ付](#20190224-ドメインヒモ付)
3. [20190224 MongoDB Export](#20190224-mongodb-export)
4. [20190224 aptで導入してしまったmongoの削除](#20190224-aptで導入してしまったmongoの削除)
5. [20190224 外部からDocker内のMongo DBに接続](#20190224-外部からdocker内のmongo-dbに接続)
6. [20190224 MongoDB Export](#20190224-mongodb-export-1)
7. [20190223 MongoDBを外部化](#20190223-mongodbを外部化)
8. [20190223 検索機能有効化](#20190223-検索機能有効化)
9. [20190223 とりあえず起動](#20190223-とりあえず起動)
10. [gitインストール](#gitインストール)
11. [20190220](#20190220)

<!-- /code_chunk_output -->
### 20190224 HTTPS 2
https://kunst1080.hatenablog.com/entry/2017/04/16/160224
https://qiita.com/kuboon/items/f424b84c718619460c6f
ここ参照して、とりあえずできた。
全部Dockerで完結させるが吉。
STAGEのコメントアウトを外すと、ちゃんとした証明書を取得してくれて、
Chromeとかで接続したときに、よく見る「保護されていません」のエラーが出なくなる。
これで完成ではなかろうか。

```yaml
version: '3'

services:
  app:
    build:
      context: .
      dockerfile: ./Dockerfile
    ports:
      - 3000    # localhost only by default
    links:
      - mongo:mongo
      - elasticsearch:elasticsearch
    depends_on:
      - mongo
      - elasticsearch
    environment:
      - MONGO_URI=mongodb://mongo:27017/growi
      - ELASTICSEARCH_URI=http://elasticsearch:9200/growi
      - PASSWORD_SEED=changeme
      # - FILE_UPLOAD=local     # activate this line if you use local storage of server rather than AWS
      # - MATHJAX=1             # activate this line if you want to use MathJax
      # - PLANTUML_URI=http://  # activate this line and specify if you use your own PlantUML server rather than public plantuml.com
      # - HACKMD_URI=http://    # activate this line and specify HackMD server URI which can be accessed from GROWI client browsers
      # - HACKMD_URI_FOR_SERVER=http://hackmd:3000  # activate this line and specify HackMD server URI which can be accessed from this server container

    command: "dockerize
              -wait tcp://mongo:27017
              -wait tcp://elasticsearch:9200
              -timeout 60s
              npm run server:prod"
    restart: unless-stopped
    volumes:
      - growi_data:/data

  https-portal:
    image: steveltn/https-portal:1
    ports:
      - '80:80'
      - '443:443'
    links:
      - app
    restart: always
    environment:
      DOMAINS: 'wiki.s-densan.tk -> http://app:3000' # <- rockerを使う場合は3838が必要！
      # STAGE: 'production' # <- 本番環境ではコメントアウトを外す


  mongo:
    image: mongo:3.4
    ports:
      - 27017:27017
# command: mongod --bind_ip 0.0.0.0
    restart: unless-stopped
    volumes:
      - mongo_configdb:/data/configdb
      - mongo_db:/data/db

  elasticsearch:
    image: elasticsearch:5.3-alpine
    environment:
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m"  # increase amount if you have enough memory
    command:
      - sh
      - -c
      - "./bin/elasticsearch-plugin list | grep -q analysis-kuromoji || ./bin/elasticsearch-plugin install analysis-kuromoji;
        ./bin/elasticsearch-plugin list | grep -q analysis-icu || ./bin/elasticsearch-plugin install analysis-icu;
        /docker-entrypoint.sh elasticsearch"
    restart: unless-stopped
    volumes:
      - es_data:/usr/share/elasticsearch/data
      - es_plugins:/usr/share/elasticsearch/plugins
      - ./esconfig:/usr/share/elasticsearch/config

volumes:
  growi_data:
  mongo_configdb:
  mongo_db:
  es_data:
  es_plugins:
```
### 20190224 HTTPS
sudo apt install certbot
sudo wget -q -O /usr/local/bin/certbot-auto https://dl.eff.org/certbot-auto
decide_in_the_eyes@growi:~$ #sudo chmod 700 /usr/local/bin/certbot-auto

https://qiita.com/ndxbn/items/7ef0a96e409a5b5837bd

sudo wget -q -O /usr/local/bin/certbot-auto https://dl.eff.org/certbot-auto
sudo chmod 700 /usr/local/bin/certbot-auto
sudo certbot-auto certonly -d wiki.s-densan.tk
sudo certbot-auto certonly --webroot --agree-tos -w /home/www/letsencrypt -m ippotei.tsukemen@gmail.com -d wiki.s-densan.tk

https://worklog.be/archives/3352#certbot-auto

Docker使っている場合
https://tech.actindi.net/2018/09/20/093414


難しすぎてわからん。
→ここがわかりやすい？
https://qiita.com/setouchi/items/b3a78cb396ae6e58b84b

```bash
decide_in_the_eyes@growi:~$ sudo docker run -it --rm -p 443:443 --name letsencrypt -v "/etc/letsencrypt:/etc/letsencrypt" -v "/var/lib/letsencrypt:/var/lib/letsencrypt" quay.io/letsencrypt/letsencrypt:latest certonly
Warning: This Docker image will soon be switching to Alpine Linux.
You can switch now using the certbot/certbot repo on Docker Hub.
/opt/certbot/venv/local/lib/python2.7/site-packages/cryptography/hazmat/primitives/constant_time.py:26: CryptographyDeprecationWarning: Support for your Python version is deprecated. The next version of cryptography will remove support. Please upgrade to a 2.7.x release that supports hmac.compare_digest as soon as possible.
  utils.DeprecatedIn23,
Saving debug log to /var/log/letsencrypt/letsencrypt.log

How would you like to authenticate with the ACME CA?
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
1: Spin up a temporary webserver (standalone)
2: Place files in webroot directory (webroot)
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Select the appropriate number [1-2] then [enter] (press 'c' to cancel): 1
Plugins selected: Authenticator standalone, Installer None
Please enter in your domain name(s) (comma and/or space separated)  (Enter 'c'
to cancel): s-densan.tk
Obtaining a new certificate
Performing the following challenges:
http-01 challenge for s-densan.tk
Waiting for verification...
Cleaning up challenges
Failed authorization procedure. s-densan.tk (http-01): urn:ietf:params:acme:error:connection :: The server could not connect to the client to verify the domain :: unknownHost :: No valid IP addresses found for s-densan.tk

IMPORTANT NOTES:                                                                                                                                                                                                                                      
 - The following errors were reported by the server:                                                                                                                                                                                                  

   Domain: s-densan.tk
   Type:   connection
   Detail: unknownHost :: No valid IP addresses found for s-densan.tk

   To fix these errors, please make sure that your domain name was
   entered correctly and the DNS A/AAAA record(s) for that domain
   contain(s) the right IP address. Additionally, please check that
   your computer has a publicly routable IP address and that no
   firewalls are preventing the server from communicating with the
   client. If you're using the webroot plugin, you should also verify
   that you are serving files from the webroot path you provided.
```

docker-compose.ymlのポートを書き換え

vim docker-compose.yml
```yaml
    ports:
      - 80:3000    # localhost only by default
      - 443:3000    # localhost only by default
```
docker起動。
sudo docker-compose up -d

いや、確かにポート443でつながるようになったが、
頭にhttpsをつけるとつながらない。そりゃそうなのかもしれない。

### 20190224 ドメインヒモ付
Freenomでドメイン取得。
今回は``s-densan.tk``で取得。

あとはここのサイトの言う通りに設定。
https://qiita.com/esplo/items/bd2e36cfae797d0d480a
```
GCP上で独自ドメインを使う
独自ドメイン
gcp
Freenom
この記事は最終更新日から1年以上が経過しています。
背景
前回の記事の続きです。
今回は、前回立ち上げたRailsに独自ドメインでアクセスできるようにしてみます。

特に手順として難しいものは無いですが、https化へのつなぎの意味合いが強い記事です。

準備
ドメインを持っていない方は、freenomなどで無料のドメインを登録しましょう。
既に持っている方は、そちらをご利用ください。

手順
StaticなIPをもらう
前回の手順の最後でExternal IPが得られたと思いますが、これはEphemeralなアドレスで、状況によって変更されてしまいます。
そこで、これをStaticなアドレスに変更します。

やり方は簡単。
Webコンソールの左のメニュー "Networking" -> "External IP addresses" から先ほどのIPの項目を選び、
EphemeralとなっているtypeをStaticに変更するだけです。
Nameは何でもOKです。

DNSゾーンを作る
まずはゾーンを作ります。
"Networking" -> "Cloud DNS" から、"CREATE ZONE"を押します。
Zone nameには適当な名前、
DNS nameには取得したドメインを入れます。

すると、NSレコードが4つ表示されます。
ns-cloud-b1.googledomains.com.など

レジストラで設定
このNSレコードをお使いのレジストラで設定します。

freenomであれば、”Manage" -> "Management Tools" -> "Nameservers"という所で5つまで設定できるので、1-4をgoogleのNameserverに設定します。
"Use custom nameservers (enter below)"をクリックし忘れると保存されないので要注意です。

Aレコードを設定する
先ほどStaticにしたIPを指定したAレコードを作ります。

確認
適当な時間をおいてアクセスしてみます。
IPでアクセスした場合と同じ表示が出れば成功です:tada:

その他
mailgunなどの設定ではドメイン認証が必要ですが、同じメニューでTXTレコードなどを追加できます。
```

ポート80でhttpアクセスできるように変更。
コロンの左右を間違えないように。
```yaml
version: '3'

services:
  app:
    build:
      context: .
      dockerfile: ./Dockerfile
    ports:
      - 80:3000    # localhost only by default
    links:
      - mongo:mongo
      - elasticsearch:elasticsearch
    depends_on:
      - mongo
      - elasticsearch
    environment:
      - MONGO_URI=mongodb://mongo:27017/growi
      - ELASTICSEARCH_URI=http://elasticsearch:9200/growi
      - PASSWORD_SEED=changeme
      # - FILE_UPLOAD=local     # activate this line if you use local storage of server rather than AWS
      # - MATHJAX=1             # activate this line if you want to use MathJax
      # - PLANTUML_URI=http://  # activate this line and specify if you use your own PlantUML server rather than public plantuml.com
      # - HACKMD_URI=http://    # activate this line and specify HackMD server URI which can be accessed from GROWI client browsers
      # - HACKMD_URI_FOR_SERVER=http://hackmd:3000  # activate this line and specify HackMD server URI which can be accessed from this server container

    command: "dockerize
              -wait tcp://mongo:27017
              -wait tcp://elasticsearch:9200
              -timeout 60s
              npm run server:prod"
    restart: unless-stopped
    volumes:
      - growi_data:/data

  mongo:
    image: mongo:3.4
    ports: 
      - 27017:27017
# command: mongod --bind_ip 0.0.0.0
    restart: unless-stopped
    volumes:
      - mongo_configdb:/data/configdb
      - mongo_db:/data/db

  elasticsearch:
    image: elasticsearch:5.3-alpine
    environment:
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m"  # increase amount if you have enough memory
    command:
      - sh
      - -c
      - "./bin/elasticsearch-plugin list | grep -q analysis-kuromoji || ./bin/elasticsearch-plugin install analysis-kuromoji;
        ./bin/elasticsearch-plugin list | grep -q analysis-icu || ./bin/elasticsearch-plugin install analysis-icu;
        /docker-entrypoint.sh elasticsearch"
    restart: unless-stopped
    volumes:
      - es_data:/usr/share/elasticsearch/data
      - es_plugins:/usr/share/elasticsearch/plugins
      - ./esconfig:/usr/share/elasticsearch/config

volumes:
  growi_data:
  mongo_configdb:
  mongo_db:
  es_data:
  es_plugins:
```

ゾーンの詳細の「レコードセットを追加」ボタンから、Aレコードを追加。
最終設定はこちら。
|      DNS 名       | タイプ | TTL（秒） |                                                                     データ                                                                      |
| ----------------- | ------ | --------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| s-densan.tk.      | NS     | 21600     | ns-cloud-e1.googledomains.com.<br/> ns-cloud-e2.googledomains.com.<br/> ns-cloud-e3.googledomains.com.<br/> ns-cloud-e4.googledomains.com.<br/> |
| s-densan.tk.      | SOA    | 21600     | ns-cloud-e1.googledomains.com. cloud-dns-hostmaster.google.com. 1 21600 3600 259200 300                                                         |
| wiki.s-densan.tk. | A      | 300       | 35.197.65.19                                                                                                                                    |

<http://wiki.s-densan.tk>でつながるように。

### 20190224 MongoDB Export
mongodb本体は必要ないので、ツールのみインストール。
```bash
sudo apt install mongo-tools -y
```
DB名とかコレクション名とかはMongoDB Compassで調べる。
```bash
decide_in_the_eyes@growi:~$ sudo mongoexport -h localhost:27017 -d growi -c users --out users.json
2019-02-24T04:38:31.099+0000    connected to: localhost:27017
2019-02-24T04:38:31.130+0000    exported 2 records
decide_in_the_eyes@growi:~$ cat users.json
{"_id":{"$oid":"5c7163aec6c034003de33c4e"},"isGravatarEnabled":false,"isEmailPublished":false,"lang":"ja","status":2,"admin":true,"createdAt":{"$date":"2019-02-23T15:15:58.897Z"},"name":"上野 慎平","username":"shimpei.ueno","email":"smpi.un.jkb.2357@gmail.com","password":"c024e42b2880a123d2dc48ad86b7c51333ea2bc64849f50c22d5f8c08a45cae4","__v":0}
{"_id":{"$oid":"5c7170d5c6c034003de33c5c"},"isGravatarEnabled":false,"isEmailPublished":true,"lang":"ja","status":4,"admin":false,"createdAt":{"$date":"2019-02-23T16:12:05.868Z"},"username":"deleted_at_1550938577439","email":"deleted_at_1550938577439@deleted","password":"","__v":0,"lastLoginAt":{"$date":"2019-02-23T16:14:09.444Z"},"name":"","googleId":null,"image":null}
```
### 20190224 aptで導入してしまったmongoの削除
```bash
sudo dpkg -l | grep mongo
ii  mongodb-clients                      1:3.6.3-0ubuntu1                    amd64        object/document-oriented database (client apps)
rc  mongodb-server                       1:3.6.3-0ubuntu1                    all          object/document-oriented database (managed server package)
ii  mongodb-server-core                  1:3.6.3-0ubuntu1                    amd64        object/document-oriented database (server binaries package)
```
```bash
sudo apt remove mongodb-server -y
sudo apt remove mongodb-clients -y
sudo apt remove mongodb-server-core -y
sudo apt autoremove mongodb-server -y
```
http://shoprev.hatenablog.com/entry/2014/09/25/205414
### 20190224 外部からDocker内のMongo DBに接続
docker-compose.ymlのmongoのところに以下の一文を入れる。
```yaml
    ports: 
      - 27017:27017
```
Dockerの内外のポートの関連付けかな。
MongoDB Compassからもアクセスできるようになる。



### 20190224 MongoDB Export
mongodbにmongoexportというコマンドがセットでついてくるらしいが、今のやり方(Dockerからインストール)だとインストールされないらしい。
```
sudo apt install mongodb -y
```
### 20190223 MongoDBを外部化
できなかった。
MongoDB Atlasで予めデータベースを作成、ファイアウォールを設定済み。

うまく行かなかった設定がこちら。

```yaml
version: '3'

services:
  app:
    build:
      context: .
      dockerfile: ./Dockerfile
    ports:
      - 3000:3000    # localhost only by default
    links:
      - elasticsearch:elasticsearch
    depends_on:
      - elasticsearch
    environment:
      #- MONGO_URI=mongodb://dbuser:dbpass@growi-shard-00-00-rl3ss.mongodb.net:27017,growi-shard-00-01-rl3ss.mongodb.net:27017,growi-shard-00-02-rl3ss.mongodb.net:27017/test?ssl=true&replicaSet=growi-shard-0&authSource=admin&retryWrites=true
      - MONGO_URI=mongodb+srv://dbuser:dbpass@growi-rl3ss.mongodb.net/test?retryWrites=true
      - ELASTICSEARCH_URI=http://elasticsearch:9200/growi
      - PASSWORD_SEED=changeme
      # - FILE_UPLOAD=local     # activate this line if you use local storage of server rather than AWS
      # - MATHJAX=1             # activate this line if you want to use MathJax
      # - PLANTUML_URI=http://  # activate this line and specify if you use your own PlantUML server rather than public plantuml.com
      # - HACKMD_URI=http://    # activate this line and specify HackMD server URI which can be accessed from GROWI client browsers
      # - HACKMD_URI_FOR_SERVER=http://hackmd:3000  # activate this line and specify HackMD server URI which can be accessed from this server container

    command: "dockerize
              -wait tcp://elasticsearch:9200
              -timeout 60s
              npm run server:prod"
    restart: unless-stopped
    volumes:
      - growi_data:/data


  elasticsearch:
    image: elasticsearch:5.3-alpine
    environment:
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m"  # increase amount if you have enough memory
    command:
      - sh
      - -c
      - "./bin/elasticsearch-plugin list | grep -q analysis-kuromoji || ./bin/elasticsearch-plugin install analysis-kuromoji;
        ./bin/elasticsearch-plugin list | grep -q analysis-icu || ./bin/elasticsearch-plugin install analysis-icu;
        /docker-entrypoint.sh elasticsearch"
    restart: unless-stopped
    volumes:
      - es_data:/usr/share/elasticsearch/data
      - es_plugins:/usr/share/elasticsearch/plugins
      - ./esconfig:/usr/share/elasticsearch/config

volumes:
  growi_data:
  es_data:
  es_plugins:
```
### 20190223 検索機能有効化
メモリ不足な気がする。
4GB必要とのこと。
https://qiita.com/SkyLaptor/items/c121a86318fdae1d64f4

```bash
free -m
              total        used        free      shared  buff/cache   available
Mem:            579         182         183           0         213         305
Swap:          1023          85         938
```

```bash
sudo swapoff /swapfile
sudo dd if=/dev/zero of=/swapfile bs=1M count=4096
sudo mkswap /swapfile
sudo swapon /swapfile

```
```bash
free -m
              total        used        free      shared  buff/cache   available
Mem:            579         253          44           0         281         231
Swap:          4095           0        4095

```
```bash
sudo docker-compose up -d
```

成功しました。
メモリ少ねえ。
MongoDBを外部化してやろうか。
```bash
decide_in_the_eyes_gmail_com@instance-1:~/growi$ free -m
              total        used        free      shared  buff/cache   available
Mem:            579         470          40           0          67          31
Swap:          4095         417        3678
```


docker-compose.ymlは以下の通り
```yaml
version: '3'
  
services:
  app:
    build:
      context: .
      dockerfile: ./Dockerfile
    ports:
      - 3000:3000    # localhost only by default
    links:
      - mongo:mongo
      - elasticsearch:elasticsearch
    depends_on:
      - mongo
      - elasticsearch
    environment:
      - MONGO_URI=mongodb://mongo:27017/growi
      - ELASTICSEARCH_URI=http://elasticsearch:9200/growi
      - PASSWORD_SEED=changeme
      # - FILE_UPLOAD=local     # activate this line if you use local storage of server rather than AWS
      # - MATHJAX=1             # activate this line if you want to use MathJax
      # - PLANTUML_URI=http://  # activate this line and specify if you use your own PlantUML server rather than public plantuml.com
      # - HACKMD_URI=http://    # activate this line and specify HackMD server URI which can be accessed from GROWI client browsers
      # - HACKMD_URI_FOR_SERVER=http://hackmd:3000  # activate this line and specify HackMD server URI which can be accessed from this server container

    command: "dockerize
              -wait tcp://mongo:27017
              -wait tcp://elasticsearch:9200
              -timeout 60s
              npm run server:prod"
    restart: unless-stopped
    volumes:
      - growi_data:/data

  mongo:
    image: mongo:3.4
    restart: unless-stopped
    volumes:
      - mongo_configdb:/data/configdb
      - mongo_db:/data/db

  elasticsearch:
    image: elasticsearch:5.3-alpine
    environment:
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m"  # increase amount if you have enough memory
    command:
      - sh
      - -c
      - "./bin/elasticsearch-plugin list | grep -q analysis-kuromoji || ./bin/elasticsearch-plugin install analysis-kuromoji;
        ./bin/elasticsearch-plugin list | grep -q analysis-icu || ./bin/elasticsearch-plugin install analysis-icu;
        /docker-entrypoint.sh elasticsearch"
    restart: unless-stopped
    volumes:
      - es_data:/usr/share/elasticsearch/data
      - es_plugins:/usr/share/elasticsearch/plugins
      - ./esconfig:/usr/share/elasticsearch/config

volumes:
  growi_data:
  mongo_configdb:
  mongo_db:
  es_data:
  es_plugins:
```


### 20190223 とりあえず起動
#### スワップ領域確保
https://www.karelie.net/free-fast-wordpress-site-kusanagi-docker/#toc_-2
作業の前にスワップ領域がないことを下記のコマンドで確認してみよう。

```bash
free -m
```
Swapが下記のように「0」と表示されていれば未設定。

```bash
              total        used        free      shared  buff/cache   available
Mem:            588         267          83          42         237         149
Swap:             0           0           0
```
Swapファイル領域を確保（処理に1ー2分かかる）

```bash
sudo dd if=/dev/zero of=/swapfile bs=1M count=1024
```
パーミッションを変更

```bash
sudo chmod 600 /swapfile
```
Swapの作成

```bash
sudo mkswap /swapfile
```
Swapを有効にする

```bash
sudo swapon /swapfile
```
Swapの確認

先ほど「0」になっていたのが「1023」となっている。

```bash
free -m
              total        used        free      shared  buff/cache   available
Mem:            588         256          69          42         262         159
Swap:          1023           0        1023
```
このままでは再起動した際にSwapファイルは無効になるので下記のコマンドで永続化する必要がある。長いコマンドなのでちゃんと行末までコピペするように。

```
sudo sed -i '$ a /swapfile                                 swap                    swap    defaults        0 0' /etc/fstab
```
念のために再起動。問題なくSwapが永続されているかを確認してみよう。
#### Dockerインストール
https://www.karelie.net/free-fast-wordpress-site-kusanagi-docker/#docker
Dockerをインストール
次にDockerに必要なパッケージをインストールする。

```
curl -fsSL https://get.docker.com/ | sh
```
問題なく起動しているか確認するために下記のコマンドを実行してみよう。

```bash
sudo docker run hello-world
```
問題なくインストールされていれば

```bash
Hello from Docker!
This message shows that your installation appears to be working correctly.
```
と表示されているはずだ。

再起動しても自動的にDockerが起動するように下記のコマンドを実行。

```bash
sudo systemctl enable docker
```
問題なく動作するか確認するためにVMインスタンスを下記のコマンドで再起動させてみる。

```bash
sudo reboot
```
SSH 再接続
上記のような画面が表示されるので「再接続」をクリック。再起動には１〜２分かかる。

もう一度下記のコマンドを実行し動作していれば大丈夫。

```bash
sudo docker run hello-world
```
#### Docker Compose
https://docs.docker.com/compose/install/
※コマンドにバージョン情報が含まれるため、最新のホームページを確認すること。
> Install Compose on Linux systems
> On Linux, you can download the Docker Compose binary from the Compose repository release page on GitHub. Follow the instructions from the link, which involve running the curl command in your terminal to download the binaries. These step by step instructions are also included below.
> 
> Run this command to download the latest version of Docker Compose:
> 
> ```bash
> sudo curl -L "https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
> ```
> Use the latest Compose release number in the download command.
> 
> The above command is an example, and it may become out-of-date. To ensure you have the latest version, check the Compose repository release page on GitHub.
> 
> If you have problems installing with curl, see Alternative Install Options tab above.
> 
> Apply executable permissions to the binary:
> 
> ```bash
> sudo chmod +x /usr/local/bin/docker-compose
> ```
> Note: If the command docker-compose fails after installation, check your path. You can also create a symbolic link to /usr/bin or any other directory in your path.
> 
> For example:
> 
> ```bash
> sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
> ```
> Optionally, install command completion for the bash and zsh shell.
> 
> Test the installation.
> 
> ```bash
> $ docker-compose --version
> docker-compose version 1.23.2, build 1110ad01
> ```
### gitインストール
入っていなければ。
http://exrecord.net/how-to-install-growi-using-docker-compose#GROWI-3
> パッケージからGitをインストール
> Gitはパッケージからインストールできます。パッケージをアップデートしたあとに、Gitをインストールします。
> ```bash
> $ sudo apt-get update
> $ sudo apt-get install git
> ```
> gitが使えるか確認
> docker-composeと同じように、問題なくインストールできたか確認のため、「git」コマンドでバージョンを確認してみましょう。
> 
> ```bash
> $ git --version
> git version 2.17.1
> ```
#### Growi インストール
http://exrecord.net/how-to-install-growi-using-docker-compose#GROWI-3
> GithubからGROWIのリポジトリをクローン
> それでは、「git」コマンドでGROWIのリポジトリをクローンします。クローン後、カレントディレクトリに「growi」というフォルダが作成されます。
> 
> ```bash
> $ git clone https://github.com/weseek/growi-docker-compose.git growi
> $ ls -ld growi
> drwxr-xr-x 6 user user 4096 Oct 10 18:58 growi
> ```
> docker-composeでGROWIを起動
> GROWIのインストールができましたので、あとはGROWIを起動できるか確認します。先ほど作成された「growi」のディレクトリに移動したあと、「docker-compose」コマンドで起動してみましょう。
> 
> ```bash
> $ cd growi
> $ sudo docker-compose up
> ```
> GROWIにアクセス
> それでは、GROWIにWebブラウザからアクセスしてみましょう。デフォルトでは、3000ポートでアクセスできますので、「http://localhost:3000」でアカウント作成画面が表示されましたら、問題なく起動できています。

``~/growi/docker-compose.yml``は以下の通りにしました。
elasticsearchを有効にすると起動に失敗するので削除。検索できないのかな？何に使っているんだろう。


```yaml
version: '3'
  
services:
  app:
    build:
      context: .
      dockerfile: ./Dockerfile
    ports:
      - 3000:3000    # localhost only by default
    links:
      - mongo:mongo
    depends_on:
      - mongo
    environment:
      - MONGO_URI=mongodb://mongo:27017/growi
      - PASSWORD_SEED=changeme
      # - FILE_UPLOAD=local     # activate this line if you use local storage of server rather than AWS
      # - MATHJAX=1             # activate this line if you want to use MathJax
      # - PLANTUML_URI=http://  # activate this line and specify if you use your own PlantUML server rather than public plantuml.com
      # - HACKMD_URI=http://    # activate this line and specify HackMD server URI which can be accessed from GROWI client browsers
      # - HACKMD_URI_FOR_SERVER=http://hackmd:3000  # activate this line and specify HackMD server URI which can be accessed from this server container

    command: "dockerize
              -wait tcp://mongo:27017
              -timeout 60s
              npm run server:prod"
    restart: unless-stopped
    volumes:
      - growi_data:/data

  mongo:
    image: mongo:3.4
    restart: unless-stopped
    volumes:
      - mongo_configdb:/data/configdb
      - mongo_db:/data/db


volumes:
  growi_data:
  mongo_configdb:
  mongo_db:
  es_data:
  es_plugins:
```

↓はオリジナル。
```yaml
version: '3'

services:
  app:
    build:
      context: .
      dockerfile: ./Dockerfile
    ports:
      - 127.0.0.1:3000:3000    # localhost only by default
    links:
      - mongo:mongo
      - elasticsearch:elasticsearch
    depends_on:
      - mongo
      - elasticsearch
    environment:
      - MONGO_URI=mongodb://mongo:27017/growi
      - ELASTICSEARCH_URI=http://elasticsearch:9200/growi
      - PASSWORD_SEED=changeme
      # - FILE_UPLOAD=local     # activate this line if you use local storage of server rather than AWS
      # - MATHJAX=1             # activate this line if you want to use MathJax
      # - PLANTUML_URI=http://  # activate this line and specify if you use your own PlantUML server rather than public plantuml.com
      # - HACKMD_URI=http://    # activate this line and specify HackMD server URI which can be accessed from GROWI client browsers
      # - HACKMD_URI_FOR_SERVER=http://hackmd:3000  # activate this line and specify HackMD server URI which can be accessed from this server container

    command: "dockerize
              -wait tcp://mongo:27017
              -wait tcp://elasticsearch:9200
              -timeout 60s
              npm run server:prod"
    restart: unless-stopped
    volumes:
      - growi_data:/data

  mongo:
    image: mongo:3.4
    restart: unless-stopped
    volumes:
      - mongo_configdb:/data/configdb
      - mongo_db:/data/db

  elasticsearch:
    image: elasticsearch:5.3-alpine
    environment:
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m"  # increase amount if you have enough memory
    command:
      - sh
      - -c
      - "./bin/elasticsearch-plugin list | grep -q analysis-kuromoji || ./bin/elasticsearch-plugin install analysis-kuromoji;
        ./bin/elasticsearch-plugin list | grep -q analysis-icu || ./bin/elasticsearch-plugin install analysis-icu;
        /docker-entrypoint.sh elasticsearch"
    restart: unless-stopped
    volumes:
      - es_data:/usr/share/elasticsearch/data
      - es_plugins:/usr/share/elasticsearch/plugins
      - ./esconfig:/usr/share/elasticsearch/config

volumes:
  growi_data:
  mongo_configdb:
  mongo_db:
  es_data:
  es_plugins:
```
### 20190220
#### Azure
https://azure.microsoft.com/ja-jp/free/free-account-faq/
無料サービスまとめ。期間限定もあるので注意。

> 無料の Azure Container Service での仮想マシンのクラスターの作成	いつでも無料

これが気になる。

Crowi関連。

###### AzureにWiki「Crowi-Plus」をインストールしてみる
https://qiita.com/HAGITAKO/items/da98f4a745ce8636a93c
丁寧な説明。無料の範囲かどうかはわからない。

###### Crowi の Docker Container を Azure VM の CentOS 上で構築する

Docker使用。Dockerよくわからない。
###### Azureの無料試用期間が終了したので、無料プランへ移行してみた

https://qiita.com/hoshimado/items/3b10a2879d4a6212d320
無料で使う際に役に立つかも。
